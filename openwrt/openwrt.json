{
  "variables": {
    "vm_name": "openwrt",
    "debian_iso_url": "https://cdimage.debian.org/cdimage/release/9.4.0/amd64/iso-cd/debian-9.4.0-amd64-netinst.iso",
    "debian_iso_checksum_type": "sha512",
    "debian_iso_checksum_url": "https://cdimage.debian.org/cdimage/release/9.4.0/amd64/iso-cd/SHA512SUMS",
    "openwrt_img_gz_url": "http://archive.openwrt.org/chaos_calmer/15.05.1/x86/64/openwrt-15.05.1-x86-64-combined-ext4.img.gz",
    "openwrt_img_gz_checksum_type": "sha256",
    "openwrt_img_gz_checksum": "be29223ee0caf3c5bdc3139e349890d4494a54a266a9d8dd1eb3f66877dc0e1b",
    "openwrt_img_gz_filename": "openwrt-15.05.1-x86-64-combined-ext4.img.gz",
    "openwrt_img_filename": "openwrt-15.05.1-x86-64-combined-ext4.img",
    "ssh_username": "vagrant",
    "ssh_password": "vagrant",
    "ssh_wait_timeout": "6h",
    "disk_size_MB": "8000",
    "disk_size_GB": "8",
    "ram_MiB": "1024",
    "http_directory": "http",
    "shutdown_command": "echo 'vagrant' | sudo -S halt"
  },
  "post-processors": [
    {
      "type": "vagrant",
      "output": "{{ user `vm_name` }}-{{.Provider}}.box",
      "compression_level": "9",
      "vagrantfile_template": "Vagrantfile"
    }
  ],
  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "Linux26_64",
      "vm_name": "{{ user `vm_name` }}",
      "iso_url": "{{ user `debian_iso_url` }}",
      "iso_checksum_type": "{{ user `debian_iso_checksum_type` }}",
      "iso_checksum_url": "{{ user `debian_iso_checksum_url` }}",
      "ssh_username": "{{ user `ssh_username` }}",
      "ssh_password": "{{ user `ssh_password` }}",
      "ssh_wait_timeout": "{{ user `ssh_wait_timeout` }}",
      "disk_size": "{{ user `disk_size_MB` }}",
      "guest_additions_mode": "disable",
      "virtualbox_version_file": "",
      "vboxmanage": [ ["modifyvm", "{{.Name}}", "--memory", "{{ user `ram_MiB` }}"] ],
      "http_directory": "{{ user `http_directory` }}",
      "boot_command": [
        "a<enter><wait>",
        "r<enter><wait10>",
        "<enter><wait>",
        "<enter><wait>",
        "<enter><wait>",
        "<wait10><wait10><wait10><wait10>",
        "<enter><wait5>",
        "<enter><wait5>",
        "<enter><wait5>",
        "<enter><wait5>",
        "<enter><wait5>",
        "<enter><wait5>",
        "wget --directory-prefix /tmp {{ user `openwrt_img_gz_url` }}<enter><wait10>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>",
        "{{ user `openwrt_img_gz_checksum_type` }}sum /tmp/{{ user `openwrt_img_gz_filename` }} | grep '{{ user `openwrt_img_gz_checksum` }}' && gunzip /tmp/{{ user `openwrt_img_gz_filename` }}<enter><wait5>",
        "dd if=/tmp/{{ user `openwrt_img_filename` }} of=/dev/sda bs=1M<enter><wait10>",
        "sync<enter><wait5>",
        "parted /dev/sda resizepart 2 {{ user `disk_size_GB` }}G<enter><wait5>",
        "resize2fs /dev/sda2<enter><wait5>",
        "reboot<enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>",
        "<enter><wait>",
        "passwd<enter><wait>",
        "vagrant<enter><wait>",
        "vagrant<enter><wait>",
        "uci set network.lan.proto=dhcp<enter><wait>",
        "uci delete network.lan.type<enter><wait>",
        "uci delete network.lan.ipaddr<enter><wait>",
        "uci delete network.lan.netmask<enter><wait>",
        "uci delete network.lan.ip6assign<enter><wait>",
        "uci commit<enter><wait>",
        "ifdown lan<enter><wait10>",
        "ifup lan<enter><wait10>",
        "wget -O /tmp/shutdown http://{{.HTTPIP}}:{{.HTTPPort}}/shutdown<enter><wait5>",
        "chmod a+x /tmp/shutdown<enter><wait>",
        "wget -O /tmp/p1 http://{{.HTTPIP}}:{{.HTTPPort}}/p1<enter><wait5>",
        "sh /tmp/p1<enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>",
        "passwd vagrant<enter><wait>",
        "vagrant<enter><wait>",
        "vagrant<enter><wait>",
        "exit<enter><wait5>",
        "<enter><wait5>",
        "wget -O /tmp/p2 http://{{.HTTPIP}}:{{.HTTPPort}}/p2<enter><wait5>",
        "sh /tmp/p2<enter>",
        "<wait10><wait10><wait10><wait10><wait10><wait10>"
      ],
      "shutdown_command": "{{ user `shutdown_command` }}"
    }
  ]
}
